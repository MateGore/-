import telebot
import random
import sqlite3
import time
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# –í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
bot = telebot.TeleBot("–í–ê–® –¢–û–ö–ï–ù")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –Ω–∞ –±–∞—Ä–∞–±–∞–Ω–∞—Ö –∏ –∏—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
symbols = ['7Ô∏è‚É£', '‚≠ê', 'üîî', 'üçã', 'üçí']

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–ø–∞–¥–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø–æ–±–µ–¥—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
spin_win_probabilities = {
    '7Ô∏è‚É£': {'three': 0.1, 'two': 0.5},
    '‚≠ê': {'three': 1.5, 'two': 2},
    'üîî': {'three': 2, 'two': 3.2},
    'üçã': {'three': 4, 'two': 7},
    'üçí': {'three': 5, 'two': 15}
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∞–Ω—Å—ã –Ω–∞ –ø–æ–±–µ–¥—É –∏ –ø—Ä–æ–∏–≥—Ä—ã—à
spin_win_chance = 0.15  # 15%
spin_lose_chance = 0.85  # 85%

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å - on, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite, —Ç–∞–±–ª–∏—Ü–∞ dkp_score, –∫–æ–ª–æ–Ω–∫–∏ - user_id, score)
conn = sqlite3.connect('–í–ê–®–ê –ë–ê–ó–ê SQLite', check_same_thread=False)
cursor = conn.cursor()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
spin_game_state = {}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å—Ö–æ–¥–∞ –∏–≥—Ä—ã
def spin_determine_outcome(user_id):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–Ω—Å –Ω–∞ –ø–æ–±–µ–¥—É
    if random.random() < spin_win_chance:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
        outcome = random.choices(
            symbols,
            weights=[spin_win_probabilities[symbol]['three'] for symbol in symbols],
            k=1
        )[0]
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –±—É–¥–µ—Ç –ª–∏ —ç—Ç–æ –≤—ã–∏–≥—Ä—ã—à –∏–∑ –¥–≤—É—Ö –∏–ª–∏ —Ç—Ä–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
        if random.random() < (spin_win_probabilities[outcome]['two'] / sum(spin_win_probabilities[outcome].values())):
            return (outcome, 2, None)
        else:
            return (outcome, 3, None)
    else:
        # –®–∞–Ω—Å –Ω–∞ –ø—Ä–æ–∏–≥—Ä—ã—à, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –≤—Å–µ–≥–¥–∞ —Ç—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞
        while True:
            display = random.choices(symbols, k=3)
            if len(set(display)) == 3:
                return (None, 0, display)

@bot.message_handler(commands=['onehandbandit'])
def spin_send_welcome(message):
    user_id = message.from_user.id
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in spin_game_state:
        spin_game_state[user_id] = {'win_streak': 0, 'initial_score': None}

    bot.reply_to(message, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É SPIN –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –±–∞—Ä–∞–±–∞–Ω–æ–≤ –∏–ª–∏ –∫–Ω–æ–ø–∫—É '–ü—Ä–∞–≤–∏–ª–∞' –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å –∏–≥—Ä–æ–π.", 
                 reply_markup=spin_create_buttons("üé∞ | üé∞ | üé∞"))

def spin_create_buttons(display):
    markup = InlineKeyboardMarkup()
    spin_button = InlineKeyboardButton("üé∞ SPIN", callback_data="spin")
    rules_button = InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="rules")
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–π –¥–∏—Å–ø–ª–µ–π –∏ –∫–Ω–æ–ø–∫–∏ SPIN –∏ –ü—Ä–∞–≤–∏–ª–∞
    markup.row(InlineKeyboardButton(display, callback_data="noop"))
    markup.row(spin_button, rules_button)
    return markup

@bot.callback_query_handler(func=lambda call: call.data == "spin")
def spin_spin(call):
    user_id = call.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    cursor.execute("SELECT score FROM dkp_score WHERE user_id = ?", (user_id,))
    current_score = cursor.fetchone()[0]

    # –ï—Å–ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ
    if spin_game_state[user_id]['initial_score'] is None:
        spin_game_state[user_id]['initial_score'] = current_score

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∏–≥—Ä–∞–ª –±–æ–ª–µ–µ 200 –æ—á–∫–æ–≤, –¥–∞–µ–º –µ–º—É –≤—ã–∏–≥—Ä—ã—à
    if spin_game_state[user_id]['initial_score'] - current_score >= 200:
        outcome, match_count = '‚≠ê', 3  # –¢—Ä–∏ –∑–≤–µ–∑–¥—ã
        spin_game_state[user_id]['initial_score'] = current_score  # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—á–µ—Ç
    else:
        outcome, match_count, display = spin_determine_outcome(user_id)

    # –°–æ–æ–±—â–µ–Ω–∏–µ "–ö—Ä—É—Ç–∏–º..." –∏ –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ 3 —Å–µ–∫—É–Ω–¥—ã
    bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                          text="–ö—Ä—É—Ç–∏–º...", reply_markup=None)
    time.sleep(3)

    if outcome is None:
        points = -5  # –ó–∞ –∫–∞–∂–¥—É—é –∫—Ä—É—Ç–∫—É –≤—ã—á–∏—Ç–∞–µ–º 5 –æ—á–∫–æ–≤
        result_text = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑! -5 –æ—á–∫–æ–≤.'
        win_streak = 0  # –°–±—Ä–æ—Å —Å—Ç—Ä–∏–∫–∞ –Ω–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–µ
    else:
        if match_count == 3:
            if outcome == '7Ô∏è‚É£':
                points = 500
                result_text = '–î–ñ–ï–ö–ü–û–¢! +500 –æ—á–∫–æ–≤!'
            elif outcome == '‚≠ê':
                points = 100
                result_text = '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! +100 –æ—á–∫–æ–≤.'
            elif outcome == 'üîî':
                points = 75
                result_text = '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! +75 –æ—á–∫–æ–≤.'
            elif outcome == 'üçã':
                points = 50
                result_text = '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! +50 –æ—á–∫–æ–≤.'
            elif outcome == 'üçí':
                points = 10
                result_text = '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! +10 –æ—á–∫–æ–≤.'
        elif match_count == 2:
            if outcome == '7Ô∏è‚É£':
                points = 100
                result_text = '+100 –æ—á–∫–æ–≤ –∑–∞ –¥–≤–∞ 7Ô∏è‚É£!'
            elif outcome == '‚≠ê':
                points = 50
                result_text = '+50 –æ—á–∫–æ–≤ –∑–∞ –¥–≤–µ ‚≠ê!'
            elif outcome == 'üîî':
                points = 25
                result_text = '+25 –æ—á–∫–æ–≤ –∑–∞ –¥–≤–∞ üîî!'
            elif outcome == 'üçã':
                points = 15
                result_text = '+15 –æ—á–∫–æ–≤ –∑–∞ –¥–≤–∞ üçã!'
            elif outcome == 'üçí':
                points = 5
                result_text = '+5 –æ—á–∫–æ–≤ –∑–∞ –¥–≤–µ üçí!'
        win_streak = spin_game_state[user_id]['win_streak'] + 1
        display = [outcome] * match_count + random.choices(symbols, k=3 - match_count)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º win_streak –≤ —Å–ª–æ–≤–∞—Ä–µ
    spin_game_state[user_id]['win_streak'] = win_streak
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    cursor.execute("UPDATE dkp_score SET score = score + ? WHERE user_id = ?", (points, user_id))
    conn.commit()
    
    # –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤
    cursor.execute("SELECT score FROM dkp_score WHERE user_id = ?", (user_id,))
    current_score = cursor.fetchone()[0]
    score_text = f"–í–∞—à —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç: {current_score} –æ—á–∫–æ–≤."
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π –∏ –∫–Ω–æ–ø–∫—É SPIN
    bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                          text=f"{result_text}\n\n{score_text}", reply_markup=spin_create_buttons(' | '.join(display)))

@bot.callback_query_handler(func=lambda call: call.data == "rules")
def spin_show_rules(call):
    # –ü–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–µ –∫–∞–∫ —Ç–µ–∫—Å—Ç
    full_rules_text = (
        "–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã '–û–¥–Ω–æ—Ä—É–∫–∏–π –±–∞–Ω–¥–∏—Ç':\n\n"
        "1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'SPIN', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ –±–∞—Ä–∞–±–∞–Ω–æ–≤.\n"
        "2. –í–∞—à–∏ –æ—á–∫–∏ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–ø–∞–≤—à–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.\n"
        "3. –ó–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à –≤—ã —Ç–µ—Ä—è–µ—Ç–µ 5 –æ—á–∫–æ–≤.\n"
        "4. –¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞ –ø—Ä–∏–Ω–æ—Å—è—Ç –±–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à, –¥–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞ - –º–µ–Ω—å—à–∏–π –≤—ã–∏–≥—Ä—ã—à.\n"
        "5. –†—É—á–∫–∞ –∫—Ä—É—Ç–∏—Ç—Å—è 3 —Å–µ–∫—É–Ω–¥—ã, –Ω–µ —Å—Ç–æ–∏—Ç –ø—ã—Ç–∞—Ç—å—Å—è –∂–∞—Ç—å —á–∞—Å—Ç–æ.\n\n"
        "–û—á–∫–∏ –∑–∞ —Å–∏–º–≤–æ–ª—ã:\n"
        "üîπ '7Ô∏è‚É£':\n"
        "   - 3 —Å–∏–º–≤–æ–ª–∞: +500 –æ—á–∫–æ–≤\n"
        "   - 2 —Å–∏–º–≤–æ–ª–∞: +100 –æ—á–∫–æ–≤\n"
        "üîπ '‚≠ê':\n"
        "   - 3 —Å–∏–º–≤–æ–ª–∞: +100 –æ—á–∫–æ–≤\n"
        "   - 2 —Å–∏–º–≤–æ–ª–∞: +50 –æ—á–∫–æ–≤\n"
        "üîπ 'üîî':\n"
        "   - 3 —Å–∏–º–≤–æ–ª–∞: +75 –æ—á–∫–æ–≤\n"
        "   - 2 —Å–∏–º–≤–æ–ª–∞: +25 –æ—á–∫–æ–≤\n"
        "üîπ 'üçã':\n"
        "   - 3 —Å–∏–º–≤–æ–ª–∞: +50 –æ—á–∫–æ–≤\n"
        "   - 2 —Å–∏–º–≤–æ–ª–∞: +15 –æ—á–∫–æ–≤\n"
        "üîπ 'üçí':\n"
        "   - 3 —Å–∏–º–≤–æ–ª–∞: +10 –æ—á–∫–æ–≤\n"
        "   - 2 —Å–∏–º–≤–æ–ª–∞: +5 –æ—á–∫–æ–≤\n\n"
        "–ê–ª–≥–æ—Ä–∏—Ç–º –∏–≥—Ä—ã –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω –Ω–∞—Å—Ç–æ—è—â–µ–º—É –æ–¥–Ω–æ—Ä—É–∫–æ–º—É –±–∞–Ω–¥–∏—Ç—É, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏–≥—Ä—É —á–µ—Å—Ç–Ω–æ–π –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–π.\n\n"
        "–£–¥–∞—á–∏ –≤ –∏–≥—Ä–µ!"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    bot.send_message(call.message.chat.id, full_rules_text)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.polling()
